<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout - E-Commerce</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- CSS -->
    <link rel="stylesheet" href="/checkout.css">
    <link rel="stylesheet" href="/homepage.css">
</head>
<body>

<!-- ================= HEADER ================= -->
<%- include('header') %>

<!-- ================= CHECKOUT CONTAINER ================= -->
<!-- ================= CHECKOUT CONTAINER ================= -->
<div class="checkout-wrapper">
    <div class="checkout-container">
        
        <!-- LEFT COLUMN - CHECKOUT STEPS -->
        <div class="checkout-steps">

            <!-- ========== STEP 1: LOGIN ========== -->
            <div class="checkout-step" id="step-login">
                <div class="step-header completed" id="login-header">
                    <div class="step-info">
                        <span class="step-num">1</span>
                        <span class="step-title">LOGIN</span>
                        <i class="fa-solid fa-check step-check"></i>
                    </div>
                    <button class="change-btn" id="change-login-btn">CHANGE</button>
                </div>
                <div class="step-content" id="login-content" style="display: none;">
                    <div class="login-info">
                        <p><strong>Flipkart Customer</strong> +917411263306</p>
                    </div>
                </div>
            </div>

            <!-- ========== STEP 2: DELIVERY ADDRESS ========== -->
            <div class="checkout-step" id="step-address">
                <div class="step-header active" id="address-header">
                    <div class="step-info">
                        <span class="step-num">2</span>
                        <span class="step-title">DELIVERY ADDRESS</span>
                        <span class="step-tick" id="address-tick">✔</span>
                    </div>
                    <button class="step-change-btn" id="address-change-btn">CHANGE</button>
                </div>
                <div class="step-content active" id="address-content">
                    
                    <!-- Saved Addresses -->
                    <div class="saved-addresses" id="saved-addresses">
                        <!-- Addresses will be dynamically added here -->
                    </div>

                    <!-- Add New Address Button -->
                    <div class="add-address-btn-wrapper">
                        <button class="add-address-btn" id="add-address-btn">
                            <i class="fa-solid fa-plus"></i>
                            Add a new address
                        </button>
                    </div>

                    <!-- Add Address Form (Hidden Initially) -->
                    <div class="address-form-wrapper" id="address-form-wrapper" style="display: none;">
                        <h3>ADD A NEW ADDRESS</h3>
                         <div class="location-box" id="location-box" style="display:none;">
                            <button type="button" class="add-address-btn" id="currentLocationBtn">
                                 Use Current Location
                            </button>

                            <button type="button" class="add-address-btn" id="mapLocationBtn">
                                 Locate on Map
                            </button>

                            <div id="map" style="height:300px;width:100%;display:none;margin-top:10px;"></div>
                        </div>
                        <form id="address-form" method="post" action="/addaddress">
                            <div class="form-row">
                                <input type="text" name="name" id="name" placeholder="Name" required>
                                <input type="tel" name="phone" id="phone" placeholder="10-digit mobile number" required>
                            </div>
                            <div class="form-row">
                                <input type="text" name="pincode" id="pincode" placeholder="Pincode" required>
                                <input type="text" name="locality" id="locality" placeholder="Locality" required>
                            </div>
                            <textarea id="address" name="addressLine" placeholder="Address (Area and Street)" required></textarea>
                            <div class="form-row">
                                <input type="text" name="city" id="city" placeholder="City/District/Town" required>
                                <input type="text" name="state" id="state" placeholder="State" required>
                            </div>
                            <div class="form-row">
                                <input type="text" name="landmark" id="landmark" placeholder="Landmark (Optional)">
                                <input type="tel" name="alternatePhone" id="alt-phone" placeholder="Alternate Phone (Optional)">
                            </div>
                            <div class="address-type">
                                <label>Address Type:</label>
                                <label>
                                    <input type="radio" name="addresstype" value="home" checked>
                                    <span>Home</span>
                                </label>
                                <label>
                                    <input type="radio" name="addresstype" value="work">
                                    <span>Work</span>
                                </label>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="save-btn">SAVE ADDRESS</button>
                                <button type="button" class="cancel-btn" id="cancel-address-btn">CANCEL</button>
                            </div>
                        </form>
                    </div>
                    <% addresses.forEach(addr => { 
                        const isSelected =
                            selectedAddressId &&
                            addr._id.toString() === selectedAddressId.toString();
                        %>

                        <div class="address-card <%= isSelected ? 'selected' : '' %>">

                        <!-- RADIO -->
                        <form method="post" action="/deliverhere">
                            <input type="hidden" name="addressId" value="<%= addr._id %>">
                            <input type="hidden" name="action" value="select">

                            <label>
                            <input
                                type="radio"
                                name="addressRadio"
                                onchange="this.form.submit()"
                                <%= isSelected ? 'checked' : '' %>
                            />

                            <strong><%= addr.name %></strong> – <%= addr.phone %><br>
                            <%= addr.addressLine %>, <%= addr.city %>, <%= addr.state %> - <%= addr.pincode %>
                            </label>
                        </form>

                        <!-- DELIVER HERE -->
                        <% if (isSelected && !addressConfirmed) { %>
                            <form method="post" action="/deliverhere">
                            <input type="hidden" name="addressId" value="<%= addr._id %>">
                            <input type="hidden" name="action" value="confirm">

                            <button type="submit" class="deliver-here-btn">
                                DELIVER HERE
                            </button>
                            </form>
                        <% } %>

                        </div>
                        <% }) %>


                </div>
            </div>

            <!-- ========== STEP 3: ORDER SUMMARY ========== -->
           

        </div>

        <!-- RIGHT COLUMN - PRICE DETAILS -->
        <div class="price-details-sidebar">
            <div class="price-details-card">
                <h3>Product & Price Details</h3>
                
                <div class="price-row">
                    <span><%=product.productName%></span>
                    <span>Price</span>
                    <span id="price-total">₹<%=product.price%></span>
                </div>

                <div class="price-row expandable" id="fees-toggle">
                    <span>Fees</span>
                </div>

                <div class="fees-breakdown" id="fees-breakdown">
                    <div class="price-row sub-row">
                        <span>Protect Promise Fee + GST</span>
                        <span id="promise-fee">₹99</span>
                    </div>
                </div>

                <div class="price-row total">
                    <span><strong>Total Payable</strong></span>
                    <span id="total-payable"><strong>₹<%=product.price + 99%></strong></span>
                     

                </div>
               <% if (addressConfirmed) { %>
                    <div class="proceed-wrapper">
                        <form action="/payment">
                            <button class="continue-btn" id="proceed">
                                PROCEED TO PAYMENT
                            </button>
                        </form>
                    </div>
                    <% } %>

                

                <div class="secure-payment">
                    <i class="fa-solid fa-shield-halved"></i>
                    <p>Safe and Secure Payments. Easy returns.<br>100% Authentic products.</p>
                </div>

                <div class="terms-text">
                    By continuing with the order, you confirm that you are above 18 years of age, and you agree to the BrandHub's 
                    <a href="#">Terms of Use</a> and <a href="#">Privacy Policy</a>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- MAP MODAL -->
<div id="mapModal" class="map-modal" style="display:none;">
  <div class="map-modal-content">
    <div class="map-modal-header">
      <h3>Select Delivery Location</h3>
      <button id="closeMapModal">✕</button>
    </div>

    

    <div id="popupMap" style="height:400px;width:100%;"></div>

    <button id="confirmLocationBtn" class="save-btn">
      CONFIRM LOCATION
    </button>
  </div>
</div>


<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGqFR-DVrDPtwB9JS-pjJwIYvDaInKTjo&libraries=places">
  
</script>

<script>
  

 
document.getElementById("proceedPaymentBtn")
  .addEventListener("click", () => {
   
    document.getElementById("address-content").style.display = "none";
    document.getElementById("order-content").style.display = "block";
  });

</script>

<script src="/checkout.js"></script>
</body>
</html>